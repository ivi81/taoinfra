# üîê –¢–∞–±–ª–∏—Ü–∞ —Å—Ö–µ–º—ã Vault –≤ Supabase

–ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ —Å—Ö–µ–º–µ `vault` –≤–∞—à–µ–≥–æ self-hosted Supabase.

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
| :--- | :--- |
| **`secrets`** | **–°–∏—Å—Ç–µ–º–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤**, —É–ø—Ä–∞–≤–ª—è–µ–º–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º `pgsodium`. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. |

---

# üìù –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π —Ç–∞–±–ª–∏—Ü—ã `vault.secrets`

> **‚ö†Ô∏è –í–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∞ —Ç–∞–±–ª–∏—Ü–∞ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã **pgsodium**. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –Ω–µ–π –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ **—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ pgsodium**, –∞ –Ω–µ —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã INSERT/UPDATE. –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pgsodium` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (`CREATE EXTENSION pgsodium;`).

–≠—Ç–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–ª—É–∂–∏—Ç –∑–∞—â–∏—â—ë–Ω–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º. –ï—ë —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º.

| –ü–æ–ª–µ (–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ) | –¢–∏–ø (–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π) | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| **`id`** | `UUID` | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ —Å–µ–∫—Ä–µ—Ç–∞. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. |
| **`secret`** | `BYTEA` | **–û—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ.** –°–æ–¥–µ—Ä–∂–∏—Ç **–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ** –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, API-–∫–ª—é—á–∏, —Ç–æ–∫–µ–Ω—ã, —à–∏—Ñ—Ä–æ–≤–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏). **–í —ç—Ç–æ–º –ø–æ–ª–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∞–π—Ç—ã.** |
| **`nonce`** | `BYTEA` | **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.** –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ (number used once), –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω–æ–≥–æ `secret`. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª—é—á–∞. |
| **`key_id`** | `BIGINT` –∏–ª–∏ `UUID` | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (`pgsodium.crypto_key`), –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞. –°–≤—è–∑—ã–≤–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º. |
| **`associated_data`** | `BYTEA` –∏–ª–∏ `TEXT` | (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∏–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ (AAD), –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏, –Ω–æ –Ω–µ —à–∏—Ñ—Ä—É—é—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏. |
| **`created_at`** | `TIMESTAMPTZ` | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ —Å–µ–∫—Ä–µ—Ç–∞. |

### üõ†Ô∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ (–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã)
**–•—Ä–∞–Ω–µ–Ω–∏–µ (Encryption):**
1.  –°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `pgsodium.crypto_key` –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.
2.  –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `nonce`.
3.  –§—É–Ω–∫—Ü–∏—è `pgsodium.crypto_aead_det_encrypt()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å:
    *   **–û—Ç–∫—Ä—ã—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º** (–≤–∞—à —Å–µ–∫—Ä–µ—Ç)
    *   **`nonce`**
    *   **`key_id`** (–∏–ª–∏ —Å–∞–º –∫–ª—é—á)
    *   (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) `associated_data`
4.  –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (ciphertext)**, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–æ–ª–µ `secret`.

**–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ (Decryption):**
1.  –°–∏—Å—Ç–µ–º–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `vault.secrets` —Å—Ç—Ä–æ–∫—É —Å –Ω—É–∂–Ω—ã–º `id`.
2.  –§—É–Ω–∫—Ü–∏—è `pgsodium.crypto_aead_det_decrypt()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å:
    *   **`secret`** (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç)
    *   **`nonce`** (–∏–∑ —ç—Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–∏)
    *   **`key_id`** (–∏–∑ —ç—Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á)
    *   (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) `associated_data`
3.  –ï—Å–ª–∏ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–µ—Ä–Ω—ã –∏ –∫–ª—é—á –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç**.

### üîê –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–∏—è
1.  **"–ü—Ä–∏–Ω–µ—Å–∏ —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏" (BYOK):** `pgsodium` –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏ —Å–∞–º –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ. –ö–æ—Ä–Ω–µ–≤–æ–π –∫–ª—é—á —á–∞—Å—Ç–æ –∑–∞—â–∏—â—ë–Ω –ø–∞—Ä–æ–ª—å–Ω–æ–π —Ñ—Ä–∞–∑–æ–π. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤—Å–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞—â–∏—Ç—ã —ç—Ç–æ–≥–æ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –∫–ª—é—á–∞.**
2.  **`nonce` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è:** –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `nonce` —Å –æ–¥–Ω–∏–º –∫–ª—é—á–æ–º –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –æ—Å–ª–∞–±–ª—è–µ—Ç –∑–∞—â–∏—Ç—É**. –°–∏—Å—Ç–µ–º–∞ `pgsodium` –∑–∞ —ç—Ç–∏–º —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–∏—Ç.
3.  **–ù–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö:** –¢–∞–∫–æ–µ —Å—Ö–µ–º–∞ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è **–∫–ª—é—á–µ–π, —Ç–æ–∫–µ–Ω–æ–≤, –Ω–µ–±–æ–ª—å—à–∏—Ö –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫**. –î–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –±–æ–ª—å—à–∏—Ö –ø–æ–ª–µ–π –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã pgsodium.
4.  **–ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω:** –ï—Å–ª–∏ –≤—ã –≤—Å—Ç–∞–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ `vault.secrets` –æ–±—ã—á–Ω—ã–º `INSERT`, –æ–Ω–∏ **–Ω–µ –±—É–¥—É—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã**. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ `pgsodium.create_secret()`.

### üíé –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
–¢–∞–±–ª–∏—Ü–∞ `vault.secrets` ‚Äî —ç—Ç–æ **–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Å–µ–∫—Ä–µ—Ç–æ–≤** —Å–∞–º–æ–≥–æ Supabase –∏–ª–∏ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, master-–∫–ª—é—á–∏ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–ª—é—á–∏ –≤–Ω–µ—à–Ω–∏—Ö API). –î–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ *–≤–∞—à–∏—Ö* —Ç–∞–±–ª–∏—Ü–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—è `encrypted_credit_card` –≤ `public.users`) –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ pgsodium**, –∞ —ç—Ç–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–ª—É–∂–∏—Ç –∏—Ö —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–æ–º.

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∞–∫—Ç–∏–≤–Ω–æ –ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ:** `SELECT * FROM pg_extension WHERE extname = 'pgsodium';`